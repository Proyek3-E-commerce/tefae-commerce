<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Manage Orders</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@48,400,0,0"
    />
    <link rel="stylesheet" href="style.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.min.css"
    />
    <style>
      /* Modal Styles */
      .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
      }

      .modal-content {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        width: 400px;
        max-height: 90%;
        overflow-y: auto;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .modal-actions button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }

      .modal-actions button:first-child {
        background-color: #4caf50;
        color: #fff;
      }

      .modal-actions button:last-child {
        background-color: #f44336;
        color: #fff;
      }

      .modal-actions button:hover {
        opacity: 0.9;
      }

      .order-table th,
      .order-table td {
        padding: 10px;
        text-align: left;
        border: 1px solid #ddd;
      }

      .order-status {
        font-weight: bold;
      }

      .order-status.pending {
        color: orange;
      }

      .order-status.confirmed {
        color: green;
      }

      .order-status.shipped {
        color: blue;
      }

      .order-status.delivered {
        color: gray;
      }
      .btn-cetak-resi {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        cursor: pointer;
        font-size: 16px;
      }
      
      .btn-cetak-resi:hover {
        background-color: #45a049;
      }
      
    </style>
  </head>
  <body>
    <div class="container">
      <aside>
        <div class="top">
          <div class="logo">
            <h2>G <span class="success">LOWING</span></h2>
          </div>
          <div class="close" id="close_btn">
            <span class="material-symbols-sharp">close</span>
          </div>
        </div>
        <div class="sidebar">
          <a href="index.html">
            <span class="material-symbols-sharp">grid_view</span>
            <h3>Dashboard</h3>
          </a>
          <a href="manage_product.html">
            <span class="material-symbols-sharp">receipt_long</span>
            <h3>Manage Products</h3>
          </a>
          <a href="orders.html" class="active">
            <span class="material-symbols-sharp">shopping_cart</span>
            <h3>Orders</h3>
          </a>
          <a href="#logout">
            <span class="material-symbols-sharp">logout</span>
            <h3>Logout</h3>
          </a>
        </div>
      </aside>

      <main id="content">
        <h1>Manage Orders</h1>
        <div class="order-section">
          <table class="order-table">
            <thead>
              <tr>
                <th>Order ID</th>
                <th>Customer ID</th>
                <th>Total Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="order-table-body">
              <!-- Orders will be loaded here dynamically -->
            </tbody>
          </table>
        </div>
      </main>
    </div>

    <!-- Modal for Update Status -->
    <div class="modal" id="updateStatusModal">
      <div class="modal-content">
        <h3>Edit Order Status</h3>
        <form id="updateStatusForm">
          <div>
            <label for="status">Status</label>
            <select id="status" required>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <div class="modal-actions">
            <button type="submit">Update Status</button>
            <button type="button" id="close-modal-btn">Close</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal for Update All Data (Edit Order) -->
    <div class="modal" id="updateAllDataModal">
      <div class="modal-content">
        <h3>Update Order</h3>
        <form id="updateAllDataForm">
          <!-- Customer and Order Info (read-only) -->
          <div>
            <label for="user_id">Customer ID</label>
            <input type="text" id="user_id" disabled />
          </div>
          <div>
            <label for="seller_id">Seller ID</label>
            <input type="text" id="seller_id" disabled />
          </div>
          <div>
            <label for="total_amount">Total Amount</label>
            <input type="number" id="total_amount" disabled />
          </div>
          <div>
            <label for="shipping_address">Shipping Address</label>
            <input type="text" id="shipping_address" disabled />
          </div>
          <div>
            <label for="status">Status</label>
            <select id="order_status" disabled>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
            </select>
          </div>
          <div>
            <label for="created_at">Created At</label>
            <input type="text" id="created_at" disabled />
          </div>
          <div>
            <label for="payment_token">Payment Token</label>
            <input type="text" id="payment_token" disabled />
          </div>

          <!-- Products List (only quantity is editable) -->
          <div id="products-list">
            <h4>Products</h4>
            <!-- Dynamic product rows will be added here -->
          </div>

          <div class="modal-actions">
            <button type="submit">Update Order</button>
            <button type="button" id="close-modal-all-btn">Close</button>
          </div>
        </form>
      </div>
    </div>

    <!-- View Order Modal -->
    <div id="viewOrderModal" class="modal">
      <div class="modal-content">
        <span id="close-view-modal-btn" class="close-btn">&times;</span>
        <h3>Order Details</h3>
        <div id="order-details"></div>
        <h4>Products</h4>
        <ul id="product-list-view"></ul>
        <!-- Cetak Resi Button -->
<div id="print-button-container" style="margin-top: 20px;"></div>
      </div>
    </div>
<!-- Include jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.5/dist/sweetalert2.all.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        const orderTableBody = document.querySelector("#order-table-body");
        const updateStatusModal = document.getElementById("updateStatusModal");
        const updateAllDataModal =
          document.getElementById("updateAllDataModal");
        const viewOrderModal = document.getElementById("viewOrderModal");
        const closeStatusModalBtn = document.getElementById("close-modal-btn");
        const closeAllDataModalBtn = document.getElementById(
          "close-modal-all-btn"
        );
        const closeViewOrderModalBtn = document.getElementById(
          "close-view-modal-btn"
        );
        const updateStatusForm = document.getElementById("updateStatusForm");
        const updateAllDataForm = document.getElementById("updateAllDataForm");
        const apiBaseUrl = "https://tefae-commerce-2c0fdca4d608.herokuapp.com";
        const ordersApi = `${apiBaseUrl}/orders`;
        const updateOrderApi = `${apiBaseUrl}/orders`;

        let sellerId = null;
        let currentOrderId = null;

        // Fetch sellerId from token
        function getSellerIdFromToken() {
          const token = localStorage.getItem("token");
          if (!token) {
            alert("You are not logged in. Please login first.");
            window.location.href = "/login.html";
            return null;
          }

          try {
            const payload = token.split(".")[1];
            const decoded = JSON.parse(atob(payload));
            return decoded.seller_id || null;
          } catch (error) {
            console.error("Error decoding token:", error);
            return null;
          }
        }

        sellerId = getSellerIdFromToken();
        if (!sellerId) return;

        // Fetch orders
        async function fetchOrders() {
          try {
            const response = await fetch(`${ordersApi}?seller_id=${sellerId}`, {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            });

            if (!response.ok) throw new Error("Failed to fetch orders");

            const result = await response.json();
            const orders = result.data || [];

            orderTableBody.innerHTML = orders
              .map(
                (order) => `
              <tr>
                <td>${order.id}</td>
                <td>${order.user_id || "No name"}</td>
                <td>Rp ${order.total_amount.toLocaleString()}</td>
                <td><span class="order-status ${getOrderStatusClass(
                  order.status
                )}">${order.status}</span></td>
                <td>
                  <button class="view-btn" data-id="${order.id}">View</button>
                  <button class="delete-btn" data-id="${
                    order.id
                  }">Delete</button>
                  <button class="status-btn" data-id="${
                    order.id
                  }">Update Status</button>
                </td>
              </tr>
            `
              )
              .join("");

            attachOrderActions();
          } catch (error) {
            console.error(error);
          }
        }

        // Handle order actions (view, edit, delete, update status)
        function attachOrderActions() {
          document.querySelectorAll(".edit-btn").forEach((button) => {
            button.addEventListener("click", (e) => {
              currentOrderId = e.target.getAttribute("data-id");
              showOrderDetails(currentOrderId);
              updateAllDataModal.style.display = "flex";
            });
          });

          document.querySelectorAll(".delete-btn").forEach((button) => {
            button.addEventListener("click", async (e) => {
              const orderId = e.target.getAttribute("data-id");
              const confirmed = await Swal.fire({
                title: "Are you sure?",
                text: "You won't be able to revert this!",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Yes, delete it!",
                cancelButtonText: "Cancel",
              });

              if (confirmed.isConfirmed) {
                await deleteOrder(orderId);
              }
            });
          });

          document.querySelectorAll(".status-btn").forEach((button) => {
            button.addEventListener("click", (e) => {
              currentOrderId = e.target.getAttribute("data-id");
              updateStatusModal.style.display = "flex";
            });
          });

          document.querySelectorAll(".view-btn").forEach((button) => {
            button.addEventListener("click", (e) => {
              currentOrderId = e.target.getAttribute("data-id");
              viewOrderModal.style.display = "flex";
              showOrderDetails(currentOrderId);
            });
          });
        }

        // Fetch order details for editing
        async function showOrderDetails(orderId) {
          try {
            const response = await fetch(`${ordersApi}/${orderId}`, {
              method: "GET",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            });

            if (!response.ok) throw new Error("Failed to fetch order details");

            const result = await response.json();
            const order = result.data;

            const orderDetails = document.getElementById("order-details");
            orderDetails.innerHTML = `
  <p><strong>Order ID:</strong> ${order.id}</p>
  <p><strong>User ID:</strong> ${order.user_id}</p>
  <p><strong>Seller ID:</strong> ${order.seller_id}</p>
  <p><strong>Status:</strong> ${order.status}</p>
  <p><strong>Shipping Address:</strong> ${order.shipping_address}</p>
  <p><strong>Total Amount:</strong> Rp ${order.total_amount.toLocaleString()}</p>
  <p><strong>Shipping Cost:</strong> Rp ${order.shipping_cost.toLocaleString()}</p>
  <p><strong>Payment Date:</strong> ${new Date(
    order.payment_date
  ).toLocaleString()}</p>
`;
// Display product items in the modal
const productListView =
document.getElementById("product-list-view");
productListView.innerHTML = ""; // Clear existing products
order.items.forEach((item) => {
const productItem = document.createElement("li");
productItem.innerHTML = `${item.name} (Quantity: ${
  item.quantity
}, Price: Rp ${parseFloat(item.price).toLocaleString()})`;
productListView.appendChild(productItem);
});

            // Add "Cetak Resi" button
const printButtonContainer = document.getElementById("print-button-container");
printButtonContainer.innerHTML = `
  <button id="print-shipping-label" class="btn-cetak-resi">Cetak Resi</button>
`;

// Add event listener for "Cetak Resi" button
document.getElementById('print-shipping-label').addEventListener('click', function() {
  // Generate PDF using jsPDF
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Set font untuk judul dan detail
  doc.setFont("helvetica", "normal");

  // Header
  doc.setFontSize(16);
  doc.text("Resi Pengiriman - Toko Anda", 14, 20);
  doc.setFontSize(12);
  doc.text("Logo Toko (Placeholder)", 14, 30); // Bisa diganti dengan logo sebenarnya
  doc.line(10, 35, 200, 35);  // Garis pemisah

  // Order Information (Biodata Order)
  doc.setFontSize(12);
  doc.text("Order ID: " + order.id, 14, 50);
  doc.text("Status: " + order.status, 14, 60);
  doc.text("Shipping Address: " + order.shipping_address, 14, 70);
  doc.text("Total Amount: Rp " + order.total_amount.toLocaleString(), 14, 80);
  doc.text("Shipping Cost: Rp " + order.shipping_cost.toLocaleString(), 14, 90);
  doc.text("Payment Date: " + new Date(order.payment_date).toLocaleString(), 14, 100);

  // Line separator
  doc.line(10, 105, 200, 105);

  // Customer Information
  doc.text("Customer Information", 14, 115);
  doc.text("User ID: " + order.user_id, 14, 125);
  doc.text("Seller ID: " + order.seller_id, 14, 135);

  // Table untuk Produk
  doc.text("Produk Pesanan:", 14, 145);

  // Table header
  const startY = 155;
  doc.setFontSize(10);
  doc.text("Nama Produk", 14, startY);
  doc.text("Kuantitas", 100, startY);
  doc.text("Harga", 140, startY);
  doc.line(10, startY + 2, 200, startY + 2); // Garis header

  // Tabel Produk
  let yPosition = startY + 10;
  order.items.forEach(item => {
    doc.text(item.name, 14, yPosition);
    doc.text(item.quantity.toString(), 100, yPosition);
    doc.text("Rp " + parseFloat(item.price).toLocaleString(), 140, yPosition);
    yPosition += 10;
  });

  // Garis pemisah untuk footer
  doc.line(10, yPosition + 5, 200, yPosition + 5);

  // Footer
  doc.setFontSize(8);
  doc.text("Terima kasih telah berbelanja di Toko Kami!", 14, yPosition + 15);
  doc.text("Alamat Toko: [Alamat Toko Anda]", 14, yPosition + 20);
  doc.text("Kontak: [Nomor Kontak Toko]", 14, yPosition + 25);

  // Save the generated PDF
  doc.save(`resi_${order.id}.pdf`);
});
          } catch (error) {
            console.error(error);
          }
        }

        // Show modal with order details
        document.querySelectorAll(".view-btn").forEach((button) => {
          button.addEventListener("click", (e) => {
            currentOrderId = e.target.getAttribute("data-id");
            viewOrderModal.style.display = "flex";
            showOrderDetails(currentOrderId);
          });
        });

        // Handle updating order status
        updateStatusForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const status = document.getElementById("status").value;

          try {
            const response = await fetch(
              `${updateOrderApi}/status/${currentOrderId}`,
              {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
                body: JSON.stringify({ status }),
              }
            );

            if (!response.ok) throw new Error("Failed to update status");

            Swal.fire({
              title: "Success!",
              text: "Order status has been updated.",
              icon: "success",
            });

            fetchOrders(); // Refresh orders
            updateStatusModal.style.display = "none"; // Close modal
          } catch (error) {
            Swal.fire({
              title: "Error",
              text: "Failed to update status",
              icon: "error",
            });
          }
        });

        // Handle updating all order data
        updateAllDataForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const customer_name = document.getElementById("customer_name").value;
          const total_amount = document.getElementById("total_amount").value;
          const status = document.getElementById("order_status").value;
          const products = [];

          // Collect product data
          document
            .querySelectorAll(".product-row")
            .forEach((productRow, index) => {
              const name = document.getElementById(
                `product-${index}-name`
              ).value;
              const quantity = document.getElementById(
                `product-${index}-quantity`
              ).value;
              const price = document.getElementById(
                `product-${index}-price`
              ).value;

              products.push({ name, quantity, price });
            });

          try {
            const response = await fetch(
              `${updateOrderApi}/${currentOrderId}`,
              {
                method: "PUT",
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  customer_name,
                  total_amount,
                  status,
                  products,
                }),
              }
            );

            if (!response.ok) throw new Error("Failed to update order");

            Swal.fire({
              title: "Success!",
              text: "Order has been updated.",
              icon: "success",
            });

            fetchOrders(); // Refresh orders
            updateAllDataModal.style.display = "none"; // Close modal
          } catch (error) {
            console.error(error);
            Swal.fire({
              title: "Error",
              text: "Failed to update order",
              icon: "error",
            });
          }
        });

        // Handle updating order status
        updateStatusForm.addEventListener("submit", async (e) => {
          e.preventDefault();

          const status = document.getElementById("order_status").value;

          try {
            const response = await fetch(
              `${updateOrderApi}/${currentOrderId}`,
              {
                method: "PUT",
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ status }),
              }
            );

            if (!response.ok) throw new Error("Failed to update status");

            Swal.fire({
              title: "Success!",
              text: "Order status has been updated.",
              icon: "success",
            });

            fetchOrders(); // Refresh orders
            updateStatusModal.style.display = "none"; // Close modal
          } catch (error) {
            console.error(error);
            Swal.fire({
              title: "Error",
              text: "Failed to update status",
              icon: "error",
            });
          }
        });

        // Utility function to get CSS class based on order status
        function getOrderStatusClass(status) {
          switch (status) {
            case "pending":
              return "pending";
            case "confirmed":
              return "confirmed";
            case "shipped":
              return "shipped";
            case "delivered":
              return "delivered";
            default:
              return "";
          }
        }

        // Handle deleting order
        async function deleteOrder(orderId) {
          try {
            const response = await fetch(`${ordersApi}/${orderId}`, {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            });

            if (!response.ok) throw new Error("Failed to delete order");

            Swal.fire({
              title: "Success!",
              text: "Order has been deleted.",
              icon: "success",
            });

            fetchOrders(); // Refresh orders
          } catch (error) {
            Swal.fire({
              title: "Error",
              text: "Failed to delete order",
              icon: "error",
            });
          }
        }
        // Close modals
        closeStatusModalBtn.addEventListener(
          "click",
          () => (updateStatusModal.style.display = "none")
        );
        closeAllDataModalBtn.addEventListener(
          "click",
          () => (updateAllDataModal.style.display = "none")
        );
        closeViewOrderModalBtn.addEventListener(
          "click",
          () => (viewOrderModal.style.display = "none")
        );

        // Fetch orders when the page loads
        fetchOrders();
      });
    </script>
  </body>
</html>
