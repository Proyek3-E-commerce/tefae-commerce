<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Products</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Sharp:opsz,wght,FILL,GRAD@48,400,0,0" />
  <link rel="stylesheet" href="style.css">
  <style>
    .modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  overflow-y: auto; /* Tambahkan ini agar modal dapat di-scroll */
  padding: 20px;    /* Jaga jarak di sekeliling modal */
}

.modal-content {
  background-color: #fff;
  padding: 20px;
  border-radius: 8px;
  width: 400px;
  max-height: 90%; /* Batasi tinggi modal agar tidak keluar dari viewport */
  overflow-y: auto; /* Scroll jika konten terlalu panjang */
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}


    form label {
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 5px;
      display: block;
      color: #333;
    }

    form input,
    form select,
    form textarea {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      color: #333;
    }

    form select {
      appearance: none;
      background-color: #fff;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTEyLjgzIDYuMjcxYS44NS44NSAwIDAgMC0uNTk1LS4yNDNsLTQuMjgxIDQuMjgxLTQuMjgxLTQuMjgxQS44NS44NSAwIDAgMCAyLjEzNiA3LjE1OUw3LjkyIDExLjkzNmEuODUuODUgMCAwIDAgMS4yMDkgMEwxMi44MyA3LjE1OUEuODUuODUgMCAwIDAgMTIuODMgNi4yNzF6IiBmaWxsPSIjOTk5Ii8+PC9zdmc+');
      background-repeat: no-repeat;
      background-position: right 10px center;
    }

    form textarea {
      resize: vertical;
      min-height: 80px;
    }

    .modal-actions {
      display: flex;
      justify-content: space-between;
    }

    .modal-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .modal-actions button:first-child {
      background-color: #4caf50;
      color: #fff;
    }

    .modal-actions button:last-child {
      background-color: #f44336;
      color: #fff;
    }

    .modal-actions button:hover {
      opacity: 0.9;
    }
  </style>
</head>
<body>
  <div class="container">
    <aside>
      <div class="top">
        <div class="logo">
          <h2>G <span class="success">LOWING</span></h2>
        </div>
        <div class="close" id="close_btn">
          <span class="material-symbols-sharp">close</span>
        </div>
      </div>
      <div class="sidebar">
        <a href="index.html">
          <span class="material-symbols-sharp">grid_view</span>
          <h3>Dashboard</h3>
        </a>
        <a href="manage_product.html" class="active">
          <span class="material-symbols-sharp">receipt_long</span>
          <h3>Manage Products</h3>
        </a>
        <a href="orders.html">
          <span class="material-symbols-sharp">shopping_cart</span>
          <h3>Orders</h3>
        </a>
        <a href="#logout">
          <span class="material-symbols-sharp">logout</span>
          <h3>Logout</h3>
        </a>
      </div>
    </aside>

    <main id="content">
      <h1>Manage Products</h1>
      <div class="product-section">
        <!-- Tombol untuk menambahkan produk -->
        <button id="add-product" style="padding: 10px 20px; margin: 20px; cursor: pointer;">Add Product</button>

        <!-- Tabel produk -->
        <table class="product-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Discount</th>
              <th>Image</th>
              <th>Category</th>
              <th>Sub-Category</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="product-table-body">
            <!-- Baris produk akan dimuat secara dinamis di sini -->
          </tbody>
        </table>
      </div>
    </main>

    <div class="right">
      <div class="top">
        <button id="menu_bar">
          <span class="material-symbols-sharp">menu</span>
        </button>
        <div class="profile">
          <div class="info">
            <p><b>Glowsie</b></p>
            <p>Seller</p>
          </div>
          <div class="profile-photo">
            <img src="./images/profile.jpeg" alt="Profile">
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    const productTableBody = document.querySelector("#product-table-body");
    const addProductButton = document.getElementById("add-product");

    let categories = [];
    let subCategories = [];
    let userId = null;

    const apiBaseUrl = "https://tefae-commerce-2c0fdca4d608.herokuapp.com";
    const categoryApi = `${apiBaseUrl}/categories`;
    const productsApi = `${apiBaseUrl}/seller/products`;
    const updateDeleteApi = `${apiBaseUrl}/sellers`;

    // **1. Ambil `user_id` dari token JWT**
    function getUserIdFromToken() {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("You are not logged in. Please login first.");
            window.location.href = "/login.html";
            return null;
        }

        try {
            const payload = token.split(".")[1];
            const decoded = JSON.parse(atob(payload));
            return decoded.user_id || null;
        } catch (error) {
            console.error("Error decoding token:", error);
            return null;
        }
    }

    userId = getUserIdFromToken();
    if (!userId) return;

    // **2. Ambil data kategori & subkategori dari API**
    async function fetchCategories() {
        try {
            const response = await fetch(categoryApi);
            const result = await response.json();
            categories = result.data || [];

            subCategories = categories.flatMap(cat =>
                cat.sub_categories.map(sub => ({ ...sub, category_id: cat.id }))
            );
        } catch (error) {
            console.error("Error fetching categories:", error);
        }
    }

    // **3. Ambil daftar produk berdasarkan user_id**
    async function fetchProducts() {
        try {
            const response = await fetch(`${productsApi}?user_id=${userId}`, {
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                }
            });

            if (!response.ok) throw new Error("Failed to fetch products");

            const result = await response.json();
            const products = result.data || [];

            productTableBody.innerHTML = products
                .map(product => `
                    <tr>
                        <td>${product.name}</td>
                        <td>Rp ${product.price.toLocaleString()}</td>
                        <td>${product.stock}</td>
                        <td>${product.discount}%</td>
                        <td>
                            <img src="${product.image ? `${apiBaseUrl}/${product.image.replace("./", "")}` : "https://tefae-commerce-2c0fdca4d608.herokuapp.com/uploads/no-image.jpg"}" 
                            alt="Product Image" style="width: 50px;">
                        </td>
                        <td>${getCategoryName(product.category_id)}</td>
                        <td>${getSubCategoryName(product.sub_category_id)}</td>
                        <td>
                            <button class="edit-btn" data-id="${product.id}">Edit</button>
                            <button class="delete-btn" data-id="${product.id}">Delete</button>
                        </td>
                    </tr>
                `).join("");

            attachEventListeners();
        } catch (error) {
            console.error("Error fetching products:", error);
        }
    }

    // **4. Fungsi mendapatkan nama kategori & subkategori berdasarkan ID**
    function getCategoryName(categoryId) {
        const category = categories.find(cat => cat.id === categoryId);
        return category ? category.name : "Unknown Category";
    }

    function getSubCategoryName(subCategoryId) {
        const subCategory = subCategories.find(sub => sub.id === subCategoryId);
        return subCategory ? subCategory.name : "Unknown Sub-Category";
    }

    // **5. Tambahkan event listener untuk tombol Add Product**
    addProductButton.addEventListener("click", () => {
        openModal("Add Product", {}, createProduct);
    });

    // **6. Membuka modal untuk tambah atau edit produk**
    function openModal(title, product = {}, onSave) {
      const modal = document.createElement("div");
      modal.className = "modal";
      modal.innerHTML = `
          <div class="modal-content">
              <h2>${title}</h2>
              <form id="modal-form">
                  <label>Name:</label>
                  <input type="text" id="product-name" value="${product.name || ""}" required>
  
                  <label>Price:</label>
                  <input type="number" id="product-price" value="${product.price || ""}" required>
  
                  <label>Stock:</label>
                  <input type="number" id="product-stock" value="${product.stock || ""}" required>
  
                  <label>Discount (%):</label>
                  <input type="number" id="product-discount" value="${product.discount || "0"}" required>
  
                  <label>Image:</label>
                  <input type="file" id="product-image">
  
                  <label>Category:</label>
                  <select id="product-category" required>
                      <option value="">Select Category</option>
                      ${categories.map(cat => `<option value="${cat.id}" ${cat.id === product.category_id ? "selected" : ""}>${cat.name}</option>`).join("")}
                  </select>
  
                  <label>Sub-Category:</label>
                  <select id="product-sub-category" required>
                      <option value="">Select Sub-Category</option>
                  </select>
  
                  <label>Description:</label>
                  <textarea id="product-description" required>${product.description || ""}</textarea>
  
                  <div class="modal-actions">
                      <button type="submit">Save</button>
                      <button type="button" id="close-modal">Cancel</button>
                  </div>
              </form>
          </div>
      `;

        document.body.appendChild(modal);

        const categoryDropdown = modal.querySelector("#product-category");
        const subCategoryDropdown = modal.querySelector("#product-sub-category");

        function populateSubCategories() {
            const selectedCategoryId = categoryDropdown.value;
            const filteredSubCategories = subCategories.filter(sub => sub.category_id === selectedCategoryId);
            subCategoryDropdown.innerHTML = `
                <option value="">Select Sub-Category</option>
                ${filteredSubCategories.map(sub => `<option value="${sub.id}" ${sub.id === product.sub_category_id ? "selected" : ""}>${sub.name}</option>`).join("")}
            `;
        }

        categoryDropdown.addEventListener("change", populateSubCategories);
        populateSubCategories(product.category_id);

        modal.querySelector("#close-modal").addEventListener("click", () => modal.remove());

        modal.querySelector("#modal-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const formData = new FormData();
        formData.append("name", modal.querySelector("#product-name").value);
        formData.append("price", modal.querySelector("#product-price").value);
        formData.append("stock", modal.querySelector("#product-stock").value);
        formData.append("discount", modal.querySelector("#product-discount").value);
        formData.append("category_id", modal.querySelector("#product-category").value);
        formData.append("sub_category_id", modal.querySelector("#product-sub-category").value);
        formData.append("description", modal.querySelector("#product-description").value);

        const imageFile = modal.querySelector("#product-image").files[0];
        if (imageFile) {
            formData.append("image", imageFile);
        }

        await onSave(formData, product.id);
        modal.remove();
        });
    }

    // **7. Fungsi Tambah Produk**
      async function createProduct(formData) {
        formData.append("seller_id", userId);
    
        try {
            const response = await fetch(productsApi, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${localStorage.getItem("token")}`
                },
                body: formData,
            });
    
            if (!response.ok) throw new Error("Failed to create product");
    
            const result = await response.json();
            alert("Product created successfully!");
            fetchProducts();
        } catch (error) {
            console.error("Error adding product:", error);
        }
      }

       // **8. Fungsi Update Produk**
    async function updateProduct(formData, productId) {
      try {
          const response = await fetch(`${productsApi}/${productId}`, {
              method: "PUT",
              headers: {
                  "Authorization": `Bearer ${localStorage.getItem("token")}`
              },
              body: formData,
          });

          if (!response.ok) throw new Error("Failed to update product");

          alert("Product updated successfully!");
          fetchProducts();
      } catch (error) {
          console.error("Error updating product:", error);
      }
  }

  // **9. Fungsi Delete Produk**
  async function deleteProduct(productId) {
      if (!confirm("Are you sure you want to delete this product?")) return;
      try {
          const response = await fetch(`${productsApi}/${productId}`, {
              method: "DELETE",
              headers: {
                  "Authorization": `Bearer ${localStorage.getItem("token")}`
              }
          });

          if (!response.ok) throw new Error("Failed to delete product");

          alert("Product deleted successfully!");
          fetchProducts();
      } catch (error) {
          console.error("Error deleting product:", error);
      }
  }

    // **10. Event Listener untuk Edit dan Delete**
    function attachEventListeners() {
      document.querySelectorAll(".edit-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
              const productId = btn.dataset.id;
              try {
                  // Fetch produk berdasarkan ID
                  const response = await fetch(`${productsApi}?user_id=${userId}`);
                  if (!response.ok) throw new Error("Failed to fetch product data");
  
                  const result = await response.json();
                  const products = result.data || [];
                  const product = products.find(p => p.id === productId);
  
                  if (!product) {
                      alert("Product not found!");
                      return;
                  }
  
                  // Buka modal edit dengan data produk
                  openModal("Edit Product", product, updateProduct);
              } catch (error) {
                  console.error("Error fetching product for editing:", error);
              }
          });
      });
  
      // **2. Tambahkan event listener untuk tombol Delete**
      document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.addEventListener("click", async () => {
              deleteProduct(btn.dataset.id);
          });
      });
  }

  await fetchCategories();
  fetchProducts();
});
</script>
</body>
</html>